---
title: 9.æœåŠ¡æä¾›è€…è°ƒç”¨çœŸå®æ–¹æ³•çš„å®ç°
date: 2024/6/09

---

## ğŸˆS

ä¸Šä¸€ç« èŠ‚å®Œæˆã€ŒæœåŠ¡æä¾›è€…ä¸æœåŠ¡æ¶ˆè´¹è€…ä¹‹é—´çš„æ•°æ®äº¤æ¢ã€ï¼Œé‚£ä¹ˆä¹‹åè¯¥å¦‚ä½•å®ç°è°ƒç”¨çœŸå®çš„æ–¹æ³•å‘¢ï¼Ÿ

æˆ‘ä»¬è¦å°½é‡å±è”½åº•å±‚å®ç°ç»†èŠ‚ï¼Œä»…ä»…ç”¨å‡ è¡Œä»£ç å°±èƒ½å®ç°æ–¹æ³•è°ƒç”¨ã€‚

## ğŸˆT

æœ¬ç« ï¼Œè¦å®ç°çš„ç›®æ ‡å°±æ˜¯ä½¿ rpc æ¡†æ¶çš„æœåŠ¡æä¾›è€…èƒ½å¤Ÿè°ƒç”¨çœŸå®çš„æ–¹æ³•ï¼Œå¹¶ä¸”èƒ½å¤Ÿå‘æœåŠ¡æ¶ˆè´¹è€…å“åº”çœŸå®æ–¹æ³•è¿”å›çš„ç»“æœæ•°æ®ã€‚

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406090035677.png"/>

éš¾ç‚¹åœ¨å“ªé‡Œï¼Ÿ

- æ€ä¹ˆçŸ¥é“è°ƒç”¨ä»€ä¹ˆçœŸå®æ–¹æ³•ï¼Ÿ
- æ€ä¹ˆæ„é€ è¯·æ±‚å‚æ•°
- æ€ä¹ˆæ„é€ è¿”å›æ¶ˆæ¯

è§£å†³ï¼š

1. æ ¹æ®ç›¸åº”çš„åè®®å¯¹å¿…è¦çš„å‚æ•°è¿›è¡Œå°è£…ï¼Œåˆ©ç”¨ã€Œå°è£…åçš„å‚æ•°ã€å»è°ƒç”¨æœåŠ¡æä¾›è€…ï¼Œ
2. æœåŠ¡æä¾›è€…æ¥æ”¶åˆ°å‚æ•°åï¼Œè¿›è¡Œè§£æï¼Œæ‰¾åˆ°å¯¹åº”çš„ã€Œã€‚çœŸå®æ–¹æ³•ã€ï¼Œä¼ é€’å¯¹åº”çš„ã€Œå‚æ•°ã€
3. ã€ŒçœŸå®æ–¹æ³•ã€æ‰§è¡Œåï¼Œè¿”å›å“åº”ç»™æœåŠ¡æä¾›è€…ã€‚
4. æœåŠ¡æä¾›è€…æ ¹æ®åè®®å°è£…å“åº”ï¼Œä¼ é€’ç»™æœåŠ¡æ¶ˆè´¹è€…ã€‚

## ğŸˆA

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406090043993.png"/>

æœåŠ¡æä¾›è€…åœ¨å¯åŠ¨æ—¶ä¼šå»æ‰«ææ ‡æœ‰ `@RpcService` çš„ç±»ï¼Œå¹¶é€šè¿‡åå°„åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ï¼Œå°†è¯¥ç±»å®ç°çš„ã€Œæ¥å£åç§°#ç‰ˆæœ¬å·#åˆ†ç»„ã€ä½œä¸º Keyï¼Œè¿™ä¸ªã€Œç±»çš„å®ä¾‹ã€ä½œä¸º value å­˜æ”¾åœ¨ä¸€ä¸ª Map é›†åˆä¸­ã€‚



æœåŠ¡æ¶ˆè´¹è€…åœ¨å‘æœåŠ¡æä¾›è€…å‘èµ·è°ƒç”¨æ—¶ï¼Œéœ€è¦ä¼ é€’ä»¥ä¸‹å‚æ•°

- è¦è°ƒç”¨çš„çœŸå®æ–¹æ³•æ‰€åœ¨çš„ç±»åç§°ã€‚
- è¦è°ƒç”¨çš„çœŸå®æ–¹æ³•çš„åç§°ã€‚
- è¦è°ƒç”¨çš„çœŸå®æ–¹æ³•çš„å‚æ•°ç±»å‹æ•°ç»„ã€‚
- è¦è°ƒç”¨çš„çœŸå®æ–¹æ³•çš„å‚æ•°æ•°ç»„ã€‚
- è¦è°ƒç”¨çš„çœŸå®æ–¹æ³•æ‰€åœ¨ç±»çš„ç‰ˆæœ¬å·ï¼Œ
- è¦è°ƒç”¨çš„çœŸå®æ–¹æ³•æ‰€åœ¨ç±»çš„åˆ†ç»„ã€‚



```java
@Slf4j
public class RpcProviderHandler extends SimpleChannelInboundHandler<RpcProtocol<RpcRequest>> {
  private final Map<String, Object> handlerMap;

  public RpcProviderHandler(Map<String, Object> handlerMap) {
    this.handlerMap = handlerMap;
  }

  @Override
  protected void channelRead0(ChannelHandlerContext ctx, RpcProtocol<RpcRequest> msg)
      throws Exception {
    ServerThreadPool.submit(
        () -> {
          // æ¶ˆæ¯å¤´
          RpcHeader header = msg.getHeader();
          header.setMsgType((byte) RpcType.RESPONSE.getType());
          log.debug("Receive request " + header.getRequestId());

          // æ¶ˆæ¯ä½“
          RpcRequest request = msg.getBody();
          RpcProtocol<RpcResponse> responseRpcProtocol = new RpcProtocol<>();
          RpcResponse response = new RpcResponse();
          try {
            // æˆåŠŸè°ƒç”¨
            Object result = handle(request);
            response.setResult(result);
            response.setAsync(request.isAsync());
            response.setOneway(request.isOneway());
            header.setStatus((byte) RpcStatus.SUCCESS.getCode());
          } catch (Throwable t) {
            // å¤±è´¥
            response.setError(t.toString());
            header.setStatus((byte) RpcStatus.FAIL.getCode());
            log.error("RPC Server handle request error", t);
          }
          // è¿”å›
          responseRpcProtocol.setHeader(header);
          responseRpcProtocol.setBody(response);
          ctx.writeAndFlush(responseRpcProtocol)
              .addListener(
                  (ChannelFutureListener)
                      channelFuture ->
                          log.debug("Send response for request " + header.getRequestId()));
        });
  }

  @Override
  public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
    log.error("server caught exception", cause);
    ctx.close();
  }

  private Object handle(RpcRequest request) throws Throwable {
    // æ„é€ key
    String serviceKey =
        RpcServiceHelper.buildServiceKey(
            request.getClassName(), request.getVersion(), request.getGroup());
    // è·å–å¯¹åº”å®ä¾‹
    Object serviceBean = handlerMap.get(serviceKey);
    if (serviceBean == null) {
      throw new RuntimeException(
          StrUtil.format(
              "service not exist: {}:{}", request.getClassName(), request.getMethodName()));
    }

    Class<?> serviceClass = serviceBean.getClass();
    String methodName = request.getMethodName();
    Class<?>[] parameterTypes = request.getParameterTypes();
    Object[] parameters = request.getParameters();

    log.debug(serviceClass.getName());
    log.debug(methodName);
    if (parameterTypes != null && parameters.length > 0) {
      for (Class<?> parameterType : parameterTypes) {
        log.debug(parameterType.getName());
      }
    }

    if (parameters != null && parameters.length > 0) {
      for (Object parameter : parameters) {
        log.debug(parameter.toString());
      }
    }
    return invokeMethod(serviceBean, serviceClass, methodName, parameterTypes, parameters);
  }

  // TODO ç›®å‰ä½¿ç”¨JDKåŠ¨æ€ä»£ç†æ–¹å¼ï¼Œæ­¤å¤„åŸ‹ç‚¹
  private Object invokeMethod(
      Object serviceBean,
      Class<?> serviceClass,
      String methodName,
      Class<?>[] parameterTypes,
      Object[] parameters)
      throws Throwable {
    log.info("Start invoking method...:");
    Method method = serviceClass.getMethod(methodName, parameterTypes);
    method.setAccessible(true);
    return method.invoke(serviceBean, parameters);
  }
}

```

åœ¨ Rpc æ¥å£æ–°å»ºä¸€ä¸ªæ–¹æ³•ï¼Œè¿›è¡Œå®ç°ã€‚

```java
@RpcService(
    interfaceClass = DemoService.class,
    interfaceClassName = "com.doublew2w.rpc.test.provider.naive.DemoService",
    group = "double")
public class ProviderService implements DemoService {

  @Override
  public String helloWorld(String name) {
    return name + " hello world";
  }
}
```

## ğŸˆR

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406090148156.png"/>
