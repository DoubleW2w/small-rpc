---
title: 13.æœåŠ¡æ¶ˆè´¹è€…å¼‚æ­¥è½¬åŒæ­¥ç›´æ¥è·å–è¿”å›ç»“æœ
date: 2024/6/09
---
## ğŸˆS

ä¸Šä¸€ç« èŠ‚å®ç°çš„åŠŸèƒ½æ˜¯ æœåŠ¡æ¶ˆè´¹è€…å¯¹å¤–å±è”½äº†åŸºäº Netty è¿æ¥æœåŠ¡æä¾›è€…çš„å®ç°ç»†èŠ‚ã€‚

ã€ŒæœåŠ¡æ¶ˆè´¹è€…ã€å‘ã€ŒæœåŠ¡æä¾›è€…ã€å‘èµ·è¯·æ±‚ï¼Œè§¦å‘æ–¹æ³• `sendRequest()`

```java
  public void sendRequest(RpcProtocol<RpcRequest> protocol) {
    log.info("æœåŠ¡æ¶ˆè´¹è€…å‘é€çš„æ•°æ®===>>>{}", JSONObject.toJSONString(protocol));
    channel.writeAndFlush(protocol);
  }
```

å½“ã€ŒæœåŠ¡æä¾›è€…ã€å¤„ç†å®Œè¯·æ±‚åï¼Œè¿”å›å“åº”ä¿¡æ¯,ã€ŒæœåŠ¡æ¶ˆè´¹è€…ã€è§¦å‘æ–¹æ³• `channelRead0()`

```java
  @Override
  protected void channelRead0(
      ChannelHandlerContext channelHandlerContext, RpcProtocol<RpcResponse> protocol)
      throws Exception {
    log.info("æœåŠ¡æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ•°æ®===>>>{}", JSONObject.toJSONString(protocol));
  }
```

## ğŸˆT

> å½“è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå°±ç›´æ¥è¿”å›ç»“æœï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿï¼ˆå³å®ŒæˆåŒæ­¥è°ƒç”¨ï¼‰
>
> ```java
> RpcConsumer consumer = RpcConsumer.getInstance();
> Object result = consumer.sendRequest(rpcRequestProtocol);
> log.info("ä»æœåŠ¡æ¶ˆè´¹è€…è·å–åˆ°çš„æ•°æ®===>>>" + result.toString());
> consumer.close();
> ```

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406092337116.png"/>

ã€Œå¤–éƒ¨æœåŠ¡ã€è°ƒç”¨ã€ŒæœåŠ¡æ¶ˆè´¹è€…ã€çš„æ–¹æ³•å‘é€æ•°æ®åï¼Œ**åŒæ­¥ç­‰å¾…** æœåŠ¡æ¶ˆè´¹è€…æ¥æ”¶åˆ°å“åº”çš„æ•°æ®åå†è¿”å›ï¼Œå°±èƒ½å¤Ÿå®ç°ç«‹å³è·å–åˆ°å“åº”çš„ç»“æœæ•°æ®ã€‚

## ğŸˆA

*RpcConsumer.java*

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406092346983.png"/>

```java
public class RpcConsumerHandler extends SimpleChannelInboundHandler<RpcProtocol<RpcResponse>> {
    /** å­˜å‚¨è¯·æ±‚ ID ä¸ RpcResponse åè®®çš„æ˜ å°„å…³ç³» */
    private Map<Long, RpcProtocol<RpcResponse>> pendingResponse = new ConcurrentHashMap<>();
    // ...
    @Override
    protected void channelRead0(
        ChannelHandlerContext channelHandlerContext, RpcProtocol<RpcResponse> protocol)
        throws Exception {
        if (protocol == null) {
            return;
        }
        log.info("æœåŠ¡æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ•°æ®===>>>{}", JSONObject.toJSONString(protocol));
        RpcHeader header = protocol.getHeader();
        long requestId = header.getRequestId();
        pendingResponse.put(requestId, protocol);
    }
    public Object sendRequest(RpcProtocol<RpcRequest> protocol) {
        log.info("æœåŠ¡æ¶ˆè´¹è€…å‘é€çš„æ•°æ®===>>>{}", JSONObject.toJSONString(protocol));
        channel.writeAndFlush(protocol);
        RpcHeader header = protocol.getHeader();
        long requestId = header.getRequestId();
        // å¼‚æ­¥è½¬åŒæ­¥
        while (true) {
            RpcProtocol<RpcResponse> responseRpcProtocol = pendingResponse.remove(requestId);
            if (responseRpcProtocol != null) {
                return responseRpcProtocol.getBody().getResult();
            }
        }
    }
}
```

- ä½¿ç”¨ pendingResponse å˜é‡å­˜å‚¨ è¯·æ±‚ ID ä¸æœåŠ¡æä¾›è€…è¿”å›çš„å“åº”ä¿¡æ¯
- åœ¨ while å¾ªç¯ä¸­ï¼Œä¸€ç›´è½®è¯¢ è¯·æ±‚ IDï¼Œå¦‚æœå“åº”å­˜åœ¨å°±ç›´æ¥è¿”å›ã€‚

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406092350919.png"/>

## ğŸˆR

åœ¨æœåŠ¡æ¶ˆè´¹è€…ç«¯å®ç°äº†å¼‚æ­¥è½¬åŒæ­¥çš„è°ƒç”¨é€»è¾‘ï¼Œä½¿å¾—å¤–éƒ¨æœåŠ¡è°ƒç”¨æœåŠ¡æ¶ˆè´¹è€…å‘é€æ•°æ®çš„æ–¹æ³•ï¼Œèƒ½å¤Ÿç›´æ¥è·å–åˆ°è¿œç¨‹æ–¹æ³•çš„è¿”å›ç»“æœã€‚

- åœ¨æœåŠ¡æä¾›è€…è¿”å›å“åº”æ—¶ï¼Œè¿›è¡Œå­˜å‚¨
- è½®è¯¢å­˜å‚¨ä¿¡æ¯ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œå°±è¿”å›ã€‚
