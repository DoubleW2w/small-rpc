---
title: 17.æœåŠ¡æ¶ˆè´¹è€…å®ç°åŠ¨æ€ä»£ç†åŠŸèƒ½å±è”½æ„å»ºè¯·æ±‚åè®®å¯¹è±¡çš„ç»†èŠ‚
date: 2024/6/12
---
## ğŸˆS

å½“æˆ‘ä»¬æ­£å¸¸å‘èµ· RPC è¯·æ±‚æ—¶ï¼Œéƒ½éœ€è¦æ‰‹åŠ¨æ„é€  RpcRequest è¯·æ±‚å¯¹è±¡

## ğŸˆT

> å¦‚ä½•åœ¨æ¶ˆè´¹è€…ç«¯å®ç° **åŠ¨æ€ä»£ç†** åŠŸèƒ½ï¼Œä½¿ç”¨ **åŠ¨æ€ä»£ç†** å±è”½æ‰æ„å»ºè¯·æ±‚åè®®å¯¹è±¡çš„ç»†èŠ‚ä¿¡æ¯ã€‚

- å¤–éƒ¨æœåŠ¡é¦–å…ˆè¦è·å–ã€Œæ¥å£ä»£ç†å¯¹è±¡ã€ï¼Œå½“å¤–éƒ¨æœåŠ¡è°ƒç”¨ã€Œæ¥å£æ–¹æ³•ã€æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨ã€Œæ¥å£ä»£ç†å¯¹è±¡ã€çš„ã€Œæ¥å£æ–¹æ³•ã€æ¥è°ƒç”¨è¿œç¨‹æ–¹æ³•
- æœåŠ¡æ¶ˆè´¹è€…æ ¹æ®å¤–éƒ¨æœåŠ¡ä¼ é€’è¿‡æ¥çš„ã€Œå‚æ•°ã€ï¼Œæ„å»ºã€Œè¯·æ±‚åè®®å¯¹è±¡ã€ï¼Œå‘æœåŠ¡æä¾›è€…å‘èµ·è¯·æ±‚

![](https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406121520436.png)

## ğŸˆA

#### æ ¸å¿ƒç±»å›¾



<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406122234034.png"/>

#### æµ‹è¯•ç±»

```java
  @Test
  public void testRpcClientCreate() {
    // æ„é€ æœåŠ¡æ¶ˆè´¹å®¢æˆ·ç«¯
    RpcClient rpcClient = new RpcClient("1.0.0", "double", "jdk", 3000, false, false);
    // æ ¹æ®æ¥å£ç±»ç”Ÿæˆäº†ä»£ç†å¯¹è±¡
    DemoService demoService = rpcClient.create(DemoService.class);
    String result = demoService.hello("double");
    log.info("è¿”å›çš„ç»“æœæ•°æ®===>>> " + result);
    rpcClient.shutdown();
  }
```

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406121804616.png"/>

```java
  public <T> T getProxy(Class<T> clazz) {
    return (T)
        Proxy.newProxyInstance(
            clazz.getClassLoader(),
            new Class<?>[] {clazz},
            new ObjectProxy<>(
                clazz,
                serviceVersion,
                serviceGroup,
                serializationType,
                timeout,
                consumer,
                async,
                oneway));
  }
```

å®é™…ä¸Šé€šè¿‡ `ObjectProxy` ç±»å»æ„é€ ä»£ç†å¯¹è±¡ã€‚

```java
public class ObjectProxy<T> implements InvocationHandler {
    //...
}
```

å½“è°ƒç”¨ `hello()` æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šèµ°çš„æ˜¯ `ObjectProxy#invoke` æ–¹æ³•

```java
@Override
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
    // å¦‚æœæ˜¯ Object ç±»
    if (Object.class == method.getDeclaringClass()) {
        return handleObjectMethods(proxy, method, args);
    }
    RpcProtocol<RpcRequest> requestRpcProtocol = new RpcProtocol<>();
    // è¯·æ±‚-æ¶ˆæ¯å¤´
    requestRpcProtocol.setHeader(RpcHeaderFactory.getRequestHeader(serializationType));
    // è¯·æ±‚-æ¶ˆæ¯ä½“
    RpcRequest request = new RpcRequest();
    request.setVersion(this.serviceVersion);
    request.setClassName(method.getDeclaringClass().getName());
    request.setMethodName(method.getName());
    request.setParameterTypes(method.getParameterTypes());
    request.setGroup(this.serviceGroup);
    request.setParameters(args);
    request.setAsync(async);
    request.setOneway(oneway);
    requestRpcProtocol.setBody(request);

    // Debug
    log.debug(method.getDeclaringClass().getName());
    log.debug(method.getName());

    if (method.getParameterTypes() != null && method.getParameterTypes().length > 0) {
        for (int i = 0; i < method.getParameterTypes().length; ++i) {
            log.debug(method.getParameterTypes()[i].getName());
        }
    }

    if (args != null && args.length > 0) {
        for (int i = 0; i < args.length; ++i) {
            log.debug(args[i].toString());
        }
    }
    // å‘é€è¯·æ±‚
    RpcFuture rpcFuture = this.consumer.sendRequest(requestRpcProtocol);
    return rpcFuture == null
        ? null
        : timeout > 0 ? rpcFuture.get(timeout, TimeUnit.MILLISECONDS) : rpcFuture.get();
}
```

- å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ Object ç±»çš„æ–¹æ³•
- å¦‚æœä¸æ˜¯ï¼Œè¯´æ˜æ‰§è¡Œçš„æ˜¯ Rpc æ¥å£å®šä¹‰çš„æ–¹æ³•
  - å®ä¾‹åŒ–è¯·æ±‚å¯¹è±¡
  - æ„é€ æ¶ˆæ¯å¤´
  - æ„é€ æ¶ˆæ¯ä½“

- å‘é€è¯·æ±‚ï¼ˆè¶…æ—¶ï¼‰
  - è°ƒç”¨ `RpcConsumerHandler#sendRequest` å‘é€è¯·æ±‚
  - è°ƒç”¨ `RpcConsumerHandler#channelRead0` æ¥æ”¶å“åº”

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406121814845.png"/>


## ğŸˆR

å¦‚ä½•ä¸ºä¸€ä¸ªæ¥å£ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡

1. è·å–æ¥å£å¯¹è±¡
2. è‡ªå®šä¹‰ä»£ç†ç±»å®ç° InvocationHandler æ¥å£ï¼Œå¹¶å®ç° `invoke()` 
3. åˆ›å»ºæ¥å£ä»£ç†å¯¹è±¡ `getProxy()`

```java
public class RpcConsumer {
    public static void main(String[] args) {
        RpcClientProxy proxy = new RpcClientProxy("localhost", 8080);
        HelloService helloService = proxy.getProxy(HelloService.class);
        String result = helloService.sayHello("World");
        System.out.println(result);
    }
}
```

```java
public class RpcClientProxy implements InvocationHandler {
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // å‘é€è¯·æ±‚
    }
    public <T> T getProxy(Class<T> interfaceClass) {
        return (T) Proxy.newProxyInstance(
                interfaceClass.getClassLoader(),
                new Class<?>[]{interfaceClass},
                this
        );
    }
}
```

