---
title: 15.æœåŠ¡æ¶ˆè´¹è€…åŒæ­¥ã€å¼‚æ­¥ã€å•å‘è°ƒç”¨çš„å®ç°
date: 2024/6/10
---
## ğŸˆS

- [x] æœåŠ¡æ¶ˆè´¹è€…å±è”½æ‰åŸºäº Netty è¿æ¥æœåŠ¡æä¾›è€…çš„å®ç°ç»†èŠ‚
- [x] å¼‚æ­¥è½¬åŒæ­¥çš„æ–¹å¼è°ƒç”¨æœåŠ¡æä¾›è€…
- [x] è°ƒç”¨æœåŠ¡æä¾›è€…æ—¶ç›´æ¥è·å–åˆ°æœåŠ¡æä¾›è€…è°ƒç”¨çœŸå®æ–¹æ³•è¿”å›çš„ç»“æœæ•°æ®

## ğŸˆT

> [!NOTE]
>
> å¦‚æœæƒ³è®©æœåŠ¡æ¶ˆè´¹è€…åŸºäºåŒæ­¥ã€å¼‚æ­¥ã€å•å‘è°ƒç”¨çš„æ–¹å¼ä¸æœåŠ¡æä¾›è€…è¿›è¡Œäº¤äº’ï¼Œè¦æ€ä¹ˆè®¾è®¡å‘¢ï¼Ÿ

- async
- oneway

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406101502089.png"/>





## ğŸˆA

*RpcConsumerHandler.java*

```java
/** æœåŠ¡æ¶ˆè´¹è€…å‘æœåŠ¡æä¾›è€…å‘é€è¯·æ±‚ */
public RpcFuture sendRequest(RpcProtocol<RpcRequest> protocol, boolean async, boolean oneway) {
    log.info("æœåŠ¡æ¶ˆè´¹è€…å‘é€çš„æ•°æ®===>>>{}", JSONObject.toJSONString(protocol));
    return oneway
        ? this.sendRequestOneway(protocol)
        : async ? sendRequestAsync(protocol) : this.sendRequestSync(protocol);
}  

/**
   * å‘èµ·åŒæ­¥è°ƒç”¨è¯·æ±‚
   *
   * @param protocol è¯·æ±‚
   * @return è¯·æ±‚çš„Future
   */
private RpcFuture sendRequestSync(RpcProtocol<RpcRequest> protocol) {
    RpcFuture rpcFuture = this.getRpcFuture(protocol);
    channel.writeAndFlush(protocol);
    return rpcFuture;
}

/**
   * å‘èµ·å•å‘è°ƒç”¨è¯·æ±‚
   *
   * @param protocol è¯·æ±‚
   * @return è¯·æ±‚çš„Future
   */
private RpcFuture sendRequestOneway(RpcProtocol<RpcRequest> protocol) {
    channel.writeAndFlush(protocol);
    return null;
}

/**
   * å‘èµ·å¼‚æ­¥è°ƒç”¨è¯·æ±‚
   *
   * @param protocol è¯·æ±‚
   * @return è¯·æ±‚çš„Future
   */
private RpcFuture sendRequestAsync(RpcProtocol<RpcRequest> protocol) {
    RpcFuture rpcFuture = this.getRpcFuture(protocol);
    // å¦‚æœæ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œåˆ™å°†RpcFutureæ”¾å…¥RpcContext
    RpcContext.getContext().setRPCFuture(rpcFuture);
    channel.writeAndFlush(protocol);
    return rpcFuture;
}
```



## ğŸˆR

### ThreadLocal å’Œ InheritableThreadLocal

`ThreadLocal` æä¾›äº†çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œè¿™äº›å˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰ç‹¬ç«‹çš„å‰¯æœ¬ï¼Œå› æ­¤æ¯ä¸ªçº¿ç¨‹å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜è‡ªå·±å‰¯æœ¬çš„å€¼ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„å‰¯æœ¬ã€‚è¿™å¯¹äºéœ€è¦åœ¨çº¿ç¨‹é—´å…±äº«æŸäº›æ•°æ®ä½†ä¸å¸Œæœ›å¼•èµ·å¹¶å‘é—®é¢˜çš„åœºæ™¯ç‰¹åˆ«æœ‰ç”¨ã€‚

- æ•°æ®åº“è¿æ¥ç®¡ç†ï¼šåœ¨æ¯ä¸ªçº¿ç¨‹ä¸­å­˜å‚¨æ•°æ®åº“è¿æ¥å¯¹è±¡ã€‚
- ç”¨æˆ·ä¼šè¯ä¿¡æ¯ï¼šåœ¨æ¯ä¸ªçº¿ç¨‹ä¸­å­˜å‚¨å½“å‰ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ã€‚
- äº‹åŠ¡ç®¡ç†ï¼šåœ¨æ¯ä¸ªçº¿ç¨‹ä¸­å­˜å‚¨å½“å‰äº‹åŠ¡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚



`InheritableThreadLocal` ç»§æ‰¿è‡ª `ThreadLocal`ï¼Œä½†å¢åŠ äº†ä¸€ä¸ªåŠŸèƒ½ï¼šå­çº¿ç¨‹å¯ä»¥ç»§æ‰¿çˆ¶çº¿ç¨‹ä¸­çš„å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“åœ¨çˆ¶çº¿ç¨‹ä¸­è®¾ç½®äº†ä¸€ä¸ª `InheritableThreadLocal` å˜é‡åï¼Œå­çº¿ç¨‹åœ¨åˆ›å»ºæ—¶ä¼šè‡ªåŠ¨è·å¾—è¿™ä¸ªå˜é‡çš„å€¼å‰¯æœ¬ã€‚



```java
public class ThreadLocalExample {
    private static ThreadLocal<Integer> threadLocal = ThreadLocal.withInitial(() -> 1);

    public static void main(String[] args) {
        Runnable task = () -> {
            System.out.println(Thread.currentThread().getName() + " initial value: " + threadLocal.get());
            threadLocal.set(threadLocal.get() + 1);
            System.out.println(Thread.currentThread().getName() + " updated value: " + threadLocal.get());
        };

        Thread thread1 = new Thread(task);
        Thread thread2 = new Thread(task);

        thread1.start();
        thread2.start();
    }
}
```

```
Thread-0 initial value: 1
Thread-1 initial value: 1
Thread-1 updated value: 2
Thread-0 updated value: 2
```

- åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œ`threadLocal` çš„åˆå§‹å€¼è®¾ç½®ä¸º 1ã€‚
- å½“ `thread1` å’Œ `thread2` å¯åŠ¨æ—¶ï¼Œåˆ†åˆ«åœ¨è‡ªå·±çš„çº¿ç¨‹å±€éƒ¨å˜é‡ä¸­è·å–åˆå§‹å€¼ï¼ˆéƒ½æ˜¯ 1ï¼‰ï¼Œå¹¶æ‰“å°å‡ºæ¥ã€‚
- æ¯ä¸ªçº¿ç¨‹å°†è‡ªå·±çš„çº¿ç¨‹å±€éƒ¨å˜é‡å€¼åŠ  1 å¹¶æ‰“å°å‡ºæ¥ï¼Œæ‰€ä»¥åˆ†åˆ«æ›´æ–°ä¸º 2ã€‚

```java
public class InheritableThreadLocalExample {
    private static InheritableThreadLocal<Integer> inheritableThreadLocal = new InheritableThreadLocal<>();

    public static void main(String[] args) {
        inheritableThreadLocal.set(1);

        Runnable task = () -> {
            System.out.println(Thread.currentThread().getName() + " initial value: " + inheritableThreadLocal.get());
            inheritableThreadLocal.set(inheritableThreadLocal.get() + 1);
            System.out.println(Thread.currentThread().getName() + " updated value: " + inheritableThreadLocal.get());
        };

        Thread thread1 = new Thread(task);
        Thread thread2 = new Thread(task);

        thread1.start();
        thread2.start();
    }
}
```

```
Thread-0 initial value: 1
Thread-1 initial value: 1
Thread-1 updated value: 2
Thread-0 updated value: 2
```

- åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œ`inheritableThreadLocal` çš„åˆå§‹å€¼è¢«è®¾ç½®ä¸º 1ã€‚
- å½“ `thread1` å’Œ `thread2` å¯åŠ¨æ—¶ï¼Œå®ƒä»¬ç»§æ‰¿äº†çˆ¶çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰çš„ `inheritableThreadLocal` å€¼ï¼Œå› æ­¤åˆå§‹å€¼éƒ½æ˜¯ 1ï¼Œå¹¶æ‰“å°å‡ºæ¥ã€‚
- æ¯ä¸ªçº¿ç¨‹å°†è‡ªå·±çš„ `inheritableThreadLocal` å€¼åŠ  1 å¹¶æ‰“å°å‡ºæ¥ï¼Œæ‰€ä»¥åˆ†åˆ«æ›´æ–°ä¸º 2ã€‚
