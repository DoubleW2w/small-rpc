---
title: 14.æœåŠ¡æ¶ˆè´¹è€…å¼‚æ­¥è½¬åŒæ­¥çš„è‡ªå®šä¹‰Futureä¸AQSå®ç°
date: 2024/6/10
---
## ğŸˆS

åœ¨ *RpcConsumerHandler.java* ä¸­å­˜åœ¨ while å¾ªç¯å®ç°è½®è¯¢æŸ¥çœ‹å“åº”æ˜¯å¦è¿”å›

```java
  /** æœåŠ¡æ¶ˆè´¹è€…å‘æœåŠ¡æä¾›è€…å‘é€è¯·æ±‚ */
  public Object sendRequest(RpcProtocol<RpcRequest> protocol) {
   //...
    while (true) {
      RpcProtocol<RpcResponse> responseRpcProtocol = pendingResponse.remove(requestId);
      if (responseRpcProtocol != null) {
        return responseRpcProtocol.getBody().getResult();
      }
    }
  }
```



## ğŸˆT

> ä½¿ç”¨ Future æ¥å£å®Œæˆå¼‚æ­¥è½¬åŒæ­¥çš„åŠŸèƒ½

å°†ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± åï¼Œè¿”å›ä¸€ä¸ª Future å¯¹è±¡ï¼Œé€šè¿‡ Future å¯¹è±¡çš„ `get()` æ–¹æ³•å°±èƒ½å¤Ÿè·å–åˆ°çº¿ç¨‹æ± ä¸­ä»»åŠ¡çš„è¿”å›ç»“æœã€‚

è¿™é‡Œï¼Œè°ƒç”¨ Future çš„ `get()` æ–¹æ³•å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡è¿”å›ç»“æœæ•°æ®ä¸ºæ­¢ã€‚

---

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406100007601.png"/>

## ğŸˆA

```java
public class RpcFuture extends CompletableFuture<Object> {
  /** åŒæ­¥é” */
  private Sync sync;

  /** è¯·æ±‚ */
  private RpcProtocol<RpcRequest> requestRpcProtocol;

  /** å“åº” */
  private RpcProtocol<RpcResponse> responseRpcProtocol;

  /** å¼€å§‹æ—¶é—´ */
  private long startTime;

  /** å“åº”è¶…æ—¶æ—¶é•¿ */
  private long responseTimeThreshold = 5000;

  public RpcFuture(RpcProtocol<RpcRequest> requestRpcProtocol) {
    this.sync = new Sync();
    this.requestRpcProtocol = requestRpcProtocol;
    this.startTime = System.currentTimeMillis();
  }

  @Override
  public boolean isDone() {
    return sync.isDone();
  }
    
  // é˜»å¡è·å– responseRpcProtocol åè®®å¯¹è±¡ä¸­çš„å®é™…ç»“æœæ•°æ®
  @Override
  public Object get() throws InterruptedException, ExecutionException {
    sync.acquire(-1);
    if (this.responseRpcProtocol != null) {
      return this.responseRpcProtocol.getBody().getResult();
    } else {
      return null;
    }
  }
    
  // è¶…æ—¶é˜»å¡è·å– responseRpcProtocol åè®®å¯¹è±¡ä¸­çš„å®é™…ç»“æœæ•°æ®
  @Override
  public Object get(long timeout, TimeUnit unit)
      throws InterruptedException, ExecutionException, TimeoutException {
    boolean success = sync.tryAcquireNanos(-1, unit.toNanos(timeout));
    if (success) {
      if (this.responseRpcProtocol != null) {
        return this.responseRpcProtocol.getBody().getResult();
      } else {
        return null;
      }
    } else {
      throw new RuntimeException(
          "Timeout exception. Request id: "
              + this.requestRpcProtocol.getHeader().getRequestId()
              + ". Request class name: "
              + this.requestRpcProtocol.getBody().getClassName()
              + ". Request method: "
              + this.requestRpcProtocol.getBody().getMethodName());
    }
  }
  // æœåŠ¡æ¶ˆè´¹è€…æ¥æ”¶åˆ°æœåŠ¡æä¾›è€…å“åº”çš„ç»“æœæ•°æ®æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œå”¤é†’é˜»å¡çš„çº¿ç¨‹
  public void done(RpcProtocol<RpcResponse> responseRpcProtocol) {
    this.responseRpcProtocol = responseRpcProtocol;
    sync.release(1);
    // Threshold
    long responseTime = System.currentTimeMillis() - startTime;
    if (responseTime > this.responseTimeThreshold) {
      log.warn(
          "Service response time is too slow. Request id = "
              + responseRpcProtocol.getHeader().getRequestId()
              + ". Response Time = "
              + responseTime
              + "ms");
    }
  }
  // ç»§æ‰¿ç±» AbstractQueuedSynchronizer ä¹Ÿå°±æ˜¯ AQS
  static class Sync extends AbstractQueuedSynchronizer {

    private static final long serialVersionUID = 1L;

    // future status
    private final int done = 1;
    private final int pending = 0;

    /**
     * å°è¯•è·å–åŒæ­¥çŠ¶æ€
     *
     */
    protected boolean tryAcquire(int acquires) {
      return getState() == done;
    }

    /**
     * å°è¯•é‡Šæ”¾åŒæ­¥çŠ¶æ€
     *
     */
    protected boolean tryRelease(int releases) {
      if (getState() == pending) {
        if (compareAndSetState(pending, done)) {
          return true;
        }
      }
      return false;
    }
	
    public boolean isDone() {
      getState();
      return getState() == done;
    }
  }
}
```



## ğŸˆR



<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406100045217.png"/>

å­¦ä¼šäº†åŸºæœ¬çš„è‡ªå®šä¹‰ Future é€»è¾‘
