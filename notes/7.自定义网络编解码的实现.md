---
title: 7.è‡ªå®šä¹‰ç½‘ç»œç¼–è§£ç çš„å®ç°
date: 2024/6/07
---
## ğŸˆS

æ•°æ®æ˜¯é€šè¿‡ã€Œç½‘ç»œä¼ è¾“åè®®ã€è¿›è¡Œä¼ è¾“çš„

- HTTP
- HTTPS
- TCP
- UDP

ä½†æ•°æ®åœ¨è¿›å…¥ç½‘ç»œä¼ è¾“ä¹‹å‰ï¼Œéœ€è¦è¿›è¡Œç¼–ç æˆäºŒè¿›åˆ¶æµä»¥åŠåœ¨æ¥æ”¶ä»¥åéœ€è¦è¿›è¡Œè§£ç æˆæ•°æ®ã€‚

**å¦‚ä½•å°† Java å¯¹è±¡è½¬åŒ–æˆæˆ‘ä»¬å®šä¹‰å¥½çš„åè®®æ ¼å¼åœ¨ç½‘ç»œä¸­è¿›è¡Œä¼ è¾“ï¼Ÿ**

## ğŸˆT

> å¦‚ä½•åœ¨è®¾è®¡å¥½è‡ªå®šä¹‰çš„ç½‘ç»œä¼ è¾“åè®®çš„åŸºç¡€ä¸Šï¼Œå®ç°æ•°æ®çš„ç¼–è§£ç åŠŸèƒ½å‘¢ï¼Ÿ



å‘é€ç«¯ï¼ˆæ¥æ”¶ç«¯ï¼‰åœ¨å‘é€æ•°æ®ï¼ˆå“åº”ï¼‰ä¹‹å‰ï¼Œå…ˆé€šè¿‡ç¼–ç å™¨æ ¹æ®è‡ªå®šä¹‰çš„ç½‘ç»œä¼ è¾“åè®®å°†æ•°æ®ç¼–ç æˆäºŒè¿›åˆ¶ï¼Œåœ¨ä¼ è¾“ç»™æ¥æ”¶ç«¯ï¼ˆå‘é€ç«¯ï¼‰

æ¥æ”¶ç«¯ï¼ˆå‘é€ç«¯ï¼‰åœ¨å¤„ç†æ•°æ®ï¼ˆå“åº”ï¼‰ä¹‹å‰ï¼Œå…ˆé€šè¿‡è§£ç å™¨æ ¹æ®è‡ªå®šä¹‰çš„ç½‘ç»œä¼ è¾“åè®®å¯¹äºŒè¿›åˆ¶è¿›è¡Œè§£ç ï¼Œè§£ç å‡ºå¯¹åº”çš„æ•°æ®ã€‚

## ğŸˆA



<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406081142960.png"/>

- RpcCodecï¼šæ•°æ®çš„ç¼–è§£ç æ¥å£ï¼Œæä¾›ä¸€ä¸ªè·å–åºåˆ—åŒ–å¯¹è±¡çš„é»˜è®¤æ–¹æ³•ã€‚
- RpcEncoderï¼šæ•°æ®çš„ç¼–ç ç±»ï¼Œæä¾›å°†æ•°æ®ç¼–ç æˆäºŒè¿›åˆ¶å­—èŠ‚æµçš„åŠŸèƒ½ï¼Œå®ç°äº† `RpcCodec` æ¥å£ã€‚
- RpcDecoderï¼šæ•°æ®çš„è§£ç ç±»ï¼Œæä¾›å°†äºŒè¿›åˆ¶æµè§£ç æˆå¯¹åº”æ•°æ®çš„åŠŸèƒ½ï¼Œå®ç°äº† `RpcCodec` æ¥å£ã€‚
- Serializationï¼šåºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„æ¥å£ã€‚
- JdkSerializationï¼šåŸºäº JDK å®ç°çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ç±»ï¼Œå®ç°äº† `Serialization` æ¥å£ã€‚

```
.
â”œâ”€â”€ notes
â”œâ”€â”€ small-rpc-annotation
â”œâ”€â”€ small-rpc-codec
â”œâ”€â”€ small-rpc-common
â”œâ”€â”€ small-rpc-constants
â”œâ”€â”€ small-rpc-protocol
â”œâ”€â”€ small-rpc-provider
â”‚   â”œâ”€â”€ small-rpc-provider-common
â”‚   â””â”€â”€ small-rpc-provider-naive
â”œâ”€â”€ small-rpc-serialization
â”‚   â”œâ”€â”€ small-rpc-serialization-api
â”‚   â””â”€â”€ small-rpc-serialization-jdk
â””â”€â”€ small-rpc-test
    â”œâ”€â”€ small-rpc-test-common
    â”œâ”€â”€ small-rpc-test-protocol
    â””â”€â”€ small-rpc-test-provider
```

æ–°å¢ small-rpc-serializationã€small-rpc-serialization-apiã€small-rpc-serialization-jdkå·¥ç¨‹

æ–°å¢ small-rpc-codec å·¥ç¨‹

## ğŸˆR

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406070142940.png"/>

æ ¹æ®å‰é¢è®¾è®¡çš„ç½‘ç»œä¼ è¾“åè®®è¿›è¡Œç¼–ç æˆ–è€…è§£ç 

```java
public class RpcDecoder extends ByteToMessageDecoder implements RpcCodec {
  @Override
  protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {
  	// å¦‚æœå¯è¯»å­—èŠ‚ < 32 ï¼Œå°±è¯´æ˜ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä¿¡æ¯ï¼Œç›´æ¥è¿”å›
    
    // æ ‡è®°è¯»ç´¢å¼•
    
    // è¯»å–é­”æ•°(short)ã€æŠ¥æ–‡(byte)ã€çŠ¶æ€(byte)ã€æ¶ˆæ¯ID(Long)ã€
    // è¯»å–åºåˆ—åŒ–ç±»å‹ï¼Œå¹¶å»é›¶
    // è¯»å–æ•°æ®é•¿åº¦
    // å¦‚æœå¯è¯»å­—èŠ‚æ•°å°äºæ¶ˆæ¯é•¿åº¦ï¼Œé‡ç½®è¯»ç´¢å¼•å¹¶è¿”å›
    // è§£ç æ¶ˆæ¯å¤´éƒ¨åˆ†
    // è§£ç æ¶ˆæ¯ä½“éƒ¨åˆ†
  }
}
```

```java
public class RpcEncoder extends MessageToByteEncoder<RpcProtocol<Object>> implements RpcCodec {

  @Override
  protected void encode(ChannelHandlerContext ctx, RpcProtocol<Object> msg, ByteBuf out)
      throws Exception {
    if (null == msg) {
      return;
    }
    // æ¶ˆæ¯å¤´
    RpcHeader header = msg.getHeader();
    out.writeShort(header.getMagic());
    out.writeByte(header.getMsgType());
    out.writeByte(header.getStatus());
    out.writeLong(header.getRequestId());
    String serializationType = header.getSerializationType();
    // TODO Serializationæ˜¯æ‰©å±•ç‚¹
    Serialization serialization = getJdkSerialization();
    out.writeBytes(
        SerializationUtils.paddingString(serializationType).getBytes(StandardCharsets.UTF_8));

    // æ¶ˆæ¯ä½“
    byte[] data = serialization.serialize(msg.getBody());
    out.writeInt(data.length);
    out.writeBytes(data);
  }
}
```

