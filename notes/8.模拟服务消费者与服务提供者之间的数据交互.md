---
title: 8.æ¨¡æ‹ŸæœåŠ¡æ¶ˆè´¹è€…ä¸æœåŠ¡æä¾›è€…ä¹‹é—´çš„æ•°æ®äº¤äº’
date: 2024/6/08
---
## ğŸˆS

- [x] è‡ªå®šä¹‰ç½‘ç»œä¼ è¾“åè®®
- [x] è‡ªå®šä¹‰æ•°æ®ç¼–ç è§£ç 
- [ ] æ¨¡æ‹Ÿæ¶ˆè´¹è€…å’Œæä¾›è€…ä¹‹é—´çš„äº¤äº’

## ğŸˆT

> å¦‚ä½•åŸºäºè‡ªå®šä¹‰çš„ç½‘ç»œä¼ è¾“åè®®å’Œæ•°æ®ç¼–è§£ç ï¼Œå®ç°æœåŠ¡æ¶ˆè´¹è€…ä¸æœåŠ¡æä¾›è€…ä¹‹é—´çš„æ•°æ®é€šä¿¡

<img src="https://doublew2w-myblogimages.oss-cn-hangzhou.aliyuncs.com/img/202406082214106.png"/>

> ä¸ºä½•è¿˜è¦è‡ªå®šä¹‰ç½‘ç»œä¼ è¾“åè®®å’Œè‡ªå®šä¹‰æ•°æ®ç¼–è§£ç å‘¢ï¼Ÿ

- å†—ä½™å­—æ®µå¤ªå¤šï¼šé€šç”¨çš„ç½‘ç»œä¼ è¾“åè®®**å†—ä½™å­—æ®µå¤ªå¤š**ï¼Œä¼šé€ æˆ**ç½‘ç»œé€šä¿¡ä¸å¤Ÿé«˜æ•ˆ**ï¼Œéœ€è¦ç²¾ç®€ï¼Œä¼ è¾“çš„æ•°æ®è¶Šå°‘è¶Šå¥½ã€‚

- é«˜æ€§èƒ½è¦æ±‚ï¼šå› ä¸ºå¯¹å…¶é«˜æ€§èƒ½çš„éœ€æ±‚ï¼Œéœ€è¦åœ¨**åè®®è®¾è®¡**å’Œ**ç¼–è§£ç è®¾è®¡**ä¸ŠæŠ•å…¥æ¯”è¾ƒå¤§çš„ç²¾åŠ›ã€‚
- å…·ä½“åœºæ™¯éœ€æ±‚ï¼š**ç»“åˆå…·ä½“åœºæ™¯å®ç°è‡ªå®šä¹‰çš„ä¼ è¾“æ ¼å¼ä¸ä¼ è¾“ä½æ ‡è¯†**ã€‚

## ğŸˆA

```java
public class RpcTestConsumerInitializer extends ChannelInitializer<SocketChannel> {
  @Override
  protected void initChannel(SocketChannel socketChannel) throws Exception {
    socketChannel
        .pipeline()
        .addLast(new RpcEncoder())
        .addLast(new RpcDecoder())
        .addLast(new RpcTestConsumerHandler());
  }
}
```

```java
@Slf4j
public class RpcTestConsumerHandler extends SimpleChannelInboundHandler<RpcProtocol<RpcResponse>> {
  @Override
  protected void channelRead0(ChannelHandlerContext ctx, RpcProtocol<RpcResponse> msg)
      throws Exception {
    log.info("æœåŠ¡æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ•°æ®===>>>{}", JSONObject.toJSONString(msg));
  }

  /**
   * å½“é€šé“è¿æ¥ä¸Šæ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•
   *
   * @param ctx é€šé“å¤„ç†å™¨ä¸Šä¸‹æ–‡
   * @throws Exception å¼‚å¸¸
   */
  @Override
  public void channelActive(ChannelHandlerContext ctx) throws Exception {
    log.info("å‘é€æ•°æ®å¼€å§‹...");
    // æ¨¡æ‹Ÿå‘é€æ•°æ®
    RpcProtocol<RpcRequest> protocol = new RpcProtocol<>();
    protocol.setHeader(RpcHeaderFactory.getRequestHeader("jdk"));
	// ...
    // æ„é€ request
    // ...
    protocol.setBody(request);
    log.info("æœåŠ¡æ¶ˆè´¹è€…å‘é€çš„æ•°æ® ===>>>{}", JSONObject.toJSONString(protocol));
    // æ¶ˆè´¹è€…å‘é€æ•°æ®
    ctx.writeAndFlush(protocol);
    log.info("å‘é€æ•°æ®å®Œæ¯•...");
  }
}
```



```java
 new ChannelInitializer<SocketChannel>() {
                @Override
                public void initChannel(SocketChannel ch) throws Exception {
                  ch.pipeline()
                      .addLast(new RpcDecoder())
                      .addLast(new RpcEncoder())
                      .addLast(new RpcProviderHandler(handlerMap));
                }
              }
```

```java
@Slf4j
public class RpcProviderHandler extends SimpleChannelInboundHandler<RpcProtocol<RpcRequest>> {
  private final Map<String, Object> handlerMap;

  public RpcProviderHandler(Map<String, Object> handlerMap) {
    this.handlerMap = handlerMap;
  }

  @Override
  protected void channelRead0(ChannelHandlerContext ctx, RpcProtocol<RpcRequest> msg)
      throws Exception {
    log.info("RPCæä¾›è€…æ”¶åˆ°çš„æ•°æ®ä¸º====>>> " + JSONObject.toJSONString(msg));
    log.info("handlerMapä¸­å­˜æ”¾çš„æ•°æ®å¦‚ä¸‹æ‰€ç¤ºï¼š");
    for (Map.Entry<String, Object> entry : handlerMap.entrySet()) {
      log.info(entry.getKey() + " === " + entry.getValue());
    }
    RpcHeader header = msg.getHeader();
    RpcRequest request = msg.getBody();
	// æ„é€ header
    // æ„é€ request
    responseRpcProtocol.setHeader(header);
    responseRpcProtocol.setBody(response);
    // ç›´æ¥è¿”å›æ•°æ®
    ctx.writeAndFlush(responseRpcProtocol);
  }
}
```

- `channelRead0`: å½“è¯»å–åˆ°æ¶ˆæ¯æ—¶ï¼Œä¼šå›è°ƒè¯¥æ–¹æ³•è¿›è¡Œå¤„ç†æ¶ˆæ¯
- `channelActive`: å½“é€šé“æ¿€æ´»æ—¶ï¼Œä¼šå›è°ƒè¯¥æ–¹æ³•ã€‚

## ğŸˆR

æ¶ˆè´¹è€…è¿›è¡Œè§£ç  <- æä¾›è€…è¿›è¡Œç¼–ç 

æ¶ˆè´¹è€…è¿›è¡Œç¼–ç  -> æä¾›è€…è¿›è¡Œè§£ç  
